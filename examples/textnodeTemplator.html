<!DOCTYPE html>
<html>
  <head>
    <title>TextNode Templator Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
      [l-view]{
        display: none;
      }
    </style>
  </head>
<body>

  <div id="main">
    FAILED
  </div>

  <div l-view="foo" templator="templator.newlinesAndLinks">$str</div>

  <script type="text/javascript" src="../../../build/lapiz.js"></script>
  <script type="text/javascript" src="../../../build/template.js"></script>
  <script type="text/javascript" src="../ui.js"></script>
  <script type="text/javascript" src="../uiHelpers.js"></script>
  <script type="text/javascript">
  
  // Demonstrates how render can append to a target.
  // The first render string will select a target in the document, all other render
  // strings will select a target in the view. Note that "baz>>" has no selector,
  // this indicates that it should append to the view, not a node within the view.
  // 
  // Also note that baz uses an l-view tag so only the contents of the tag are
  // appended.


  var linkRe = /(https?:\/\/[^\s]+)/g;

  Lapiz.UI.mediator.templator("newlinesAndLinks", function(){
    var parentTemplator = Lapiz.UI.bindState.templator;
    return function(template, ctx){
      var ret = parentTemplator(template, ctx);
      if (Lapiz.typeCheck.string(ret)){
        ret = ret.split("\n");
        if (ret.length === 1){
          return ret[0];
        }
        var doc = document.createDocumentFragment();
        Lapiz.each(ret, function(str, i){
          var a;
          str = str.split(linkRe);
          Lapiz.UI.appendChild("textnode", doc).textContent = str.shift();
          while(str.length > 0){
            a = Lapiz.UI.appendChild("a", doc);
            a.href = str.shift();
            a.target = "_blank";
            Lapiz.UI.appendChild("textnode", a).textContent = a.href;
            Lapiz.UI.appendChild("textnode", doc).textContent = str.shift();
          }
          if (i<ret.length-1){
            Lapiz.UI.appendChild("br", doc);
          }
        });
        ret = doc;
      }
      return ret;
    }
  })

  var ctx = {
    'str' : "This is \n a test\nhttp://projects.adamcolton.net/lapiz/components/ui/examples/textnodeTemplator.html\nDone"
  };

  Lapiz.UI.render("foo > #main", ctx);
  </script>
  </body>
</html>